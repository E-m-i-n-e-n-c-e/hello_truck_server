generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id               String               @id @default(uuid())
  phoneNumber      String               @unique
  firstName        String?
  lastName         String?
  email            String?
  isBusiness       Boolean              @default(false)
  referralCode     String?              @unique
  isActive         Boolean              @default(true)
  walletBalance    Decimal              @default(0) @db.Decimal(10, 2)
  bookingCount     Int                  @default(0)
  profileCreatedAt DateTime?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  bookings        Booking[]
  gstDetails      CustomerGstDetails[]
  appliedReferral CustomerReferral?    @relation("CustomerReferred")
  referrals       CustomerReferral[]   @relation("CustomerReferrer")
  sessions        CustomerSession[]
  walletLogs      CustomerWalletLog[]
  refundIntents   RefundIntent[]
  addresses       SavedAddress[]
  transactions    Transaction[]
  // Admin Portal Relations
  adminRefundRequests AdminRefundRequest[]

  @@index([isActive])
  @@index([referralCode])
}

model Address {
  id               String        @id @default(uuid())
  formattedAddress String
  addressDetails   String?
  latitude         Decimal       @db.Decimal(10, 8)
  longitude        Decimal       @db.Decimal(11, 8)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  savedAddresses   SavedAddress?

  @@index([latitude, longitude])
}

model SavedAddress {
  id           String   @id @default(uuid())
  name         String
  contactName  String
  contactPhone String
  noteToDriver String?
  customerId   String
  addressId    String   @unique
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  address      Address  @relation(fields: [addressId], references: [id])
  customer     Customer @relation(fields: [customerId], references: [id])

  @@unique([name, customerId], name: "unique_name_per_customer")
  @@index([customerId])
}

model CustomerGstDetails {
  id              String   @id @default(uuid())
  customerId      String
  gstNumber       String   @unique
  businessName    String
  businessAddress String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId, isActive])
  @@index([createdAt])
}

model CustomerSession {
  id             String    @id @default(uuid())
  customerId     String
  token          String    @unique
  oldToken       String?   @unique
  expiresAt      DateTime
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  fcmToken       String?
  lastNotifiedAt DateTime?
  customer       Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([customerId])
  @@index([fcmToken])
}

model Driver {
  id                 String              @id @default(uuid())
  phoneNumber        String              @unique
  firstName          String?
  lastName           String?
  email              String?
  alternatePhone     String?
  photo              String?
  contactId          String?
  fundAccountId      String?
  score              Int                 @default(100)
  isActive           Boolean             @default(true)
  verificationStatus VerificationStatus  @default(PENDING)
  driverStatus       DriverStatus        @default(UNAVAILABLE)
  walletBalance      Decimal             @default(0) @db.Decimal(10, 2)
  profileCreatedAt   DateTime?
  createdAt          DateTime            @default(now())
  lastSeenAt         DateTime?
  updatedAt          DateTime            @updatedAt
  payoutMethod       PayoutMethodType?
  referralCode       String?             @unique
  rideCount          Int                 @default(0)
  bookings           Booking[]
  assignments        BookingAssignment[]
  address            DriverAddress?
  documents          DriverDocuments?
  paymentLinks       DriverPaymentLink[]
  appliedReferral    DriverReferral?     @relation("DriverReferred")
  referrals          DriverReferral[]    @relation("DriverReferrer")
  sessions           DriverSession[]
  statusLogs         DriverStatusLog[]
  walletLogs         DriverWalletLog[]
  payouts            Payout[]
  transactions       Transaction[]
  vehicle            Vehicle?
  // Admin Portal Relations
  verificationRequests DriverVerificationRequest[]
  adminRefundRequests  AdminRefundRequest[]

  @@index([isActive, verificationStatus])
  @@index([lastSeenAt, driverStatus])
}

model DriverDocuments {
  id                       String             @id @default(uuid())
  driverId                 String             @unique
  licenseUrl               String
  licenseExpiry            DateTime?
  licenseStatus            VerificationStatus @default(PENDING)
  rcBookUrl                String
  fcUrl                    String
  fcExpiry                 DateTime?
  fcStatus                 VerificationStatus @default(PENDING)
  insuranceUrl             String
  insuranceExpiry          DateTime?
  insuranceStatus          VerificationStatus @default(PENDING)
  aadharUrl                String
  panNumber                String
  ebBillUrl                String
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  rcBookExpiry             DateTime?
  rcBookStatus             VerificationStatus @default(PENDING)
  selfieUrl                String?
  suggestedFcExpiry        DateTime?
  suggestedInsuranceExpiry DateTime?
  suggestedLicenseExpiry   DateTime?
  suggestedRcBookExpiry    DateTime?
  aadharNumberEncrypted    String             @default("RandomHash")
  aadharNumberHash         String             @default("RandomHash")
  driver                   Driver             @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([licenseExpiry])
  @@index([rcBookExpiry])
  @@index([fcExpiry])
  @@index([insuranceExpiry])
  @@index([aadharNumberHash])
  @@index([panNumber])
}

model DriverSession {
  id             String    @id @default(uuid())
  driverId       String
  token          String    @unique
  oldToken       String?   @unique
  expiresAt      DateTime
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  fcmToken       String?
  lastNotifiedAt DateTime?
  driver         Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([driverId])
  @@index([fcmToken])
}

model Vehicle {
  id                String          @id @default(uuid())
  driverId          String          @unique
  vehicleNumber     String
  vehicleType       VehicleType
  vehicleBodyLength Decimal         @db.Decimal(3, 1)
  vehicleBodyType   VehicleBodyType
  fuelType          FuelType
  vehicleImageUrl   String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  vehicleModelName  String
  driver            Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicleModel      VehicleModel    @relation(fields: [vehicleModelName], references: [name])
  owner             VehicleOwner?

  @@index([vehicleNumber])
  @@index([vehicleModelName])
  @@index([vehicleType])
}

model VehicleModel {
  name          String    @id
  perKm         Decimal   @db.Decimal(10, 2)
  baseKm        Int
  baseFare      Decimal   @db.Decimal(10, 2)
  maxWeightTons Decimal   @db.Decimal(10, 2)
  vehicles      Vehicle[]
}

model VehicleOwner {
  id            String   @id @default(uuid())
  vehicleId     String   @unique
  name          String
  aadharUrl     String
  contactNumber String
  addressLine1  String
  landmark      String?
  pincode       String
  city          String
  district      String
  state         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  vehicle       Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model DriverAddress {
  id           String   @id @default(uuid())
  driverId     String   @unique
  addressLine1 String
  landmark     String?
  pincode      String
  city         String
  district     String
  state        String
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  driver       Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
}

model DriverStatusLog {
  id              String       @id @default(uuid())
  driverId        String
  status          DriverStatus
  statusChangedAt DateTime     @default(now())
  driver          Driver       @relation(fields: [driverId], references: [id])

  @@index([driverId, status])
  @@index([statusChangedAt])
}

model Package {
  id                String         @id @default(uuid())
  productType       ProductType
  productName       String?
  approximateWeight Decimal        @db.Decimal(10, 2)
  weightUnit        WeightUnit     @default(KG)
  bundleWeight      Decimal?       @db.Decimal(10, 2)
  numberOfProducts  Int?
  length            Decimal?       @db.Decimal(10, 2)
  width             Decimal?       @db.Decimal(10, 2)
  height            Decimal?       @db.Decimal(10, 2)
  dimensionUnit     DimensionUnit? @default(CM)
  description       String?
  packageImageUrl   String?
  gstBillUrl        String?
  transportDocUrls  String[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  booking           Booking?
}

model BookingAddress {
  id               String   @id @default(uuid())
  addressName      String?
  noteToDriver     String?
  contactName      String
  contactPhone     String
  formattedAddress String
  addressDetails   String?
  latitude         Decimal  @db.Decimal(10, 8)
  longitude        Decimal  @db.Decimal(11, 8)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  dropBooking      Booking? @relation("DropAddress")
  pickupBooking    Booking? @relation("PickupAddress")

  @@index([latitude, longitude])
}

model Booking {
  id                 String              @id @default(uuid())
  bookingNumber      BigInt              @unique @default(autoincrement())
  customerId         String?
  packageId          String              @unique
  pickupAddressId    String              @unique
  dropAddressId      String              @unique
  pickupOtp          String
  dropOtp            String
  acceptedAt         DateTime?
  pickupArrivedAt    DateTime?
  pickupVerifiedAt   DateTime?
  dropArrivedAt      DateTime?
  dropVerifiedAt     DateTime?
  completedAt        DateTime?
  status             BookingStatus       @default(PENDING)
  assignedDriverId   String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  scheduledAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  gstNumber          String?
  assignedDriver     Driver?             @relation(fields: [assignedDriverId], references: [id])
  customer           Customer?           @relation(fields: [customerId], references: [id])
  dropAddress        BookingAddress      @relation("DropAddress", fields: [dropAddressId], references: [id])
  package            Package             @relation(fields: [packageId], references: [id])
  pickupAddress      BookingAddress      @relation("PickupAddress", fields: [pickupAddressId], references: [id])
  assignments        BookingAssignment[]
  statusLogs         BookingStatusLog[]
  customerWalletLogs CustomerWalletLog[]
  driverWalletLogs   DriverWalletLog[]
  invoices           Invoice[]
  refundIntents      RefundIntent?
  transactions       Transaction[]
  // Admin Portal Relations
  adminRefundRequest AdminRefundRequest?
  supportNotes       SupportNote[]

  @@index([customerId, status])
  @@index([assignedDriverId, status])
  @@index([status, createdAt])
}

model BookingAssignment {
  id             String           @id @default(uuid())
  bookingId      String
  driverId       String
  status         AssignmentStatus @default(OFFERED)
  offeredAt      DateTime         @default(now())
  respondedAt    DateTime?
  commissionRate Decimal?         @db.Decimal(5, 4)
  booking        Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  driver         Driver           @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([bookingId, driverId])
  @@index([bookingId, status])
  @@index([driverId, status])
  @@index([status, offeredAt])
}

model BookingStatusLog {
  id              String        @id @default(uuid())
  bookingId       String
  status          BookingStatus
  statusChangedAt DateTime      @default(now())
  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, status])
  @@index([statusChangedAt])
}

model Invoice {
  id                 String         @id @default(uuid())
  bookingId          String
  type               InvoiceType
  vehicleModelName   String
  basePrice          Decimal        @db.Decimal(10, 2)
  perKmPrice         Decimal        @db.Decimal(10, 2)
  baseKm             Int
  distanceKm         Decimal        @db.Decimal(10, 2)
  weightInTons       Decimal        @db.Decimal(10, 2)
  effectiveBasePrice Decimal        @db.Decimal(10, 2)
  totalPrice         Decimal        @db.Decimal(10, 2)
  walletApplied      Decimal        @default(0) @db.Decimal(10, 2)
  finalAmount        Decimal        @db.Decimal(10, 2)
  paymentLinkUrl     String?
  rzpPaymentId       String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  isPaid             Boolean        @default(false)
  paidAt             DateTime?
  rzpPaymentLinkId   String?        @unique
  paymentMethod      PaymentMethod?
  platformFee        Decimal        @default(20) @db.Decimal(10, 2)
  gstNumber          String?
  booking            Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@unique([bookingId, type])
  @@index([bookingId])
  @@index([gstNumber])
}

model Transaction {
  id             String              @id @default(uuid())
  customerId     String?
  driverId       String?
  amount         Decimal             @db.Decimal(10, 2)
  type           TransactionType
  category       TransactionCategory
  description    String
  bookingId      String?
  payoutId       String?
  metadata       Json?
  createdAt      DateTime            @default(now())
  paymentMethod  PaymentMethod
  refundIntentId String?
  booking        Booking?            @relation(fields: [bookingId], references: [id])
  customer       Customer?           @relation(fields: [customerId], references: [id])
  driver         Driver?             @relation(fields: [driverId], references: [id])
  payout         Payout?             @relation(fields: [payoutId], references: [id])
  refundIntent   RefundIntent?       @relation(fields: [refundIntentId], references: [id])

  @@index([customerId, createdAt])
  @@index([driverId, createdAt])
  @@index([bookingId])
  @@index([payoutId])
  @@index([category, createdAt])
}

model Payout {
  id               String        @id @default(uuid())
  driverId         String
  amount           Decimal       @db.Decimal(10, 2)
  razorpayPayoutId String?       @unique
  status           PayoutStatus  @default(PENDING)
  failureReason    String?
  retryCount       Int           @default(0)
  createdAt        DateTime      @default(now())
  processedAt      DateTime?
  driver           Driver        @relation(fields: [driverId], references: [id], onDelete: Cascade)
  transactions     Transaction[]

  @@index([driverId, status])
  @@index([status, createdAt])
}

model DriverWalletLog {
  id            String   @id @default(uuid())
  driverId      String
  beforeBalance Decimal  @db.Decimal(10, 2)
  afterBalance  Decimal  @db.Decimal(10, 2)
  amount        Decimal  @db.Decimal(10, 2)
  reason        String
  bookingId     String?
  createdAt     DateTime @default(now())
  booking       Booking? @relation(fields: [bookingId], references: [id])
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, createdAt])
  @@index([createdAt])
}

model DriverPaymentLink {
  id          String   @id @default(uuid())
  driverId    String
  createdAt   DateTime @default(now())
  referenceId String   @unique
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
}

model CustomerWalletLog {
  id             String        @id @default(uuid())
  customerId     String
  beforeBalance  Decimal       @db.Decimal(10, 2)
  afterBalance   Decimal       @db.Decimal(10, 2)
  amount         Decimal       @db.Decimal(10, 2)
  reason         String
  bookingId      String?
  createdAt      DateTime      @default(now())
  refundIntentId String?
  booking        Booking?      @relation(fields: [bookingId], references: [id])
  customer       Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  refundIntent   RefundIntent? @relation(fields: [refundIntentId], references: [id])

  @@index([customerId, createdAt])
  @@index([createdAt])
}

model RefundIntent {
  id                   String              @id @default(uuid())
  bookingId            String              @unique
  customerId           String
  walletRefundAmount   Decimal             @db.Decimal(10, 2)
  razorpayRefundAmount Decimal             @db.Decimal(10, 2)
  cancellationCharge   Decimal             @db.Decimal(10, 2)
  rzpPaymentId         String?
  rzpRefundId          String?
  status               RefundStatus        @default(PENDING)
  failureReason        String?
  retryCount           Int                 @default(0)
  maxRetries           Int                 @default(3)
  createdAt            DateTime            @default(now())
  processedAt          DateTime?
  wasPaid              Boolean
  refundFactor         Decimal?            @db.Decimal(10, 2)
  isApproved           Boolean             @default(true) // false for admin refunds awaiting approval, true for internal cancellations
  customerWalletLogs   CustomerWalletLog[]
  booking              Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer             Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions         Transaction[]

  @@index([status])
  @@index([bookingId])
  @@index([isApproved, status])
}

model CustomerReferral {
  id                     String   @id @default(uuid())
  referrerId             String
  referredId             String   @unique
  referrerRewardApplied  Boolean  @default(false)
  referredRewardApplied  Boolean  @default(false)
  createdAt              DateTime @default(now())
  referred               Customer @relation("CustomerReferred", fields: [referredId], references: [id], onDelete: Cascade)
  referrer               Customer @relation("CustomerReferrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId, referrerRewardApplied])
}

model DriverReferral {
  id                     String   @id @default(uuid())
  referrerId             String
  referredId             String   @unique
  referrerRewardApplied  Boolean  @default(false)
  referredRewardApplied  Boolean  @default(false)
  createdAt              DateTime @default(now())
  referred               Driver   @relation("DriverReferred", fields: [referredId], references: [id], onDelete: Cascade)
  referrer               Driver   @relation("DriverReferrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId, referrerRewardApplied])
}

model WebhookLog {
  id        String   @id @default(uuid())
  event     String
  payload   Json
  signature String
  createdAt DateTime @default(now())
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VehicleType {
  THREE_WHEELER
  FOUR_WHEELER
}

enum VehicleBodyType {
  OPEN
  CLOSED
}

enum FuelType {
  DIESEL
  PETROL
  EV
  CNG
}

enum ProductType {
  PERSONAL
  AGRICULTURAL
  NON_AGRICULTURAL
}

enum WeightUnit {
  KG
  QUINTAL
}

enum DimensionUnit {
  CM
  INCHES
}

enum BookingStatus {
  PENDING
  DRIVER_ASSIGNED
  CONFIRMED
  PICKUP_ARRIVED
  PICKUP_VERIFIED
  IN_TRANSIT
  DROP_ARRIVED
  DROP_VERIFIED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum AssignmentStatus {
  OFFERED
  ACCEPTED
  REJECTED
  AUTO_REJECTED
  CANCELLED
}

enum DriverStatus {
  AVAILABLE
  UNAVAILABLE
  ON_RIDE
  RIDE_OFFERED
}

enum LifecycleEventType {
  PICKUP_ARRIVED
  PICKUP_VERIFIED
  IN_TRANSIT
  DROP_ARRIVED
  DROP_VERIFIED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ReferralStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionCategory {
  BOOKING_PAYMENT
  BOOKING_REFUND
  DRIVER_PAYOUT
  DRIVER_PAYMENT
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum InvoiceType {
  ESTIMATE
  FINAL
}

enum PaymentMethod {
  ONLINE
  CASH
}

enum PayoutMethodType {
  BANK_ACCOUNT
  VPA
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  NOT_REQUIRED
}

// ============================================
// ADMIN PORTAL MODELS
// ============================================

// Admin Users (Multi-user system for admin portal)
model AdminUser {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  role          AdminRole
  firstName     String
  lastName      String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions              AdminSession[]
  auditLogs             AuditLog[]
  assignedVerifications DriverVerificationRequest[] @relation("AssignedTo")
  approvedVerifications DriverVerificationRequest[] @relation("ApprovedBy")
  createdRefunds        AdminRefundRequest[]        @relation("CreatedBy")
  approvedRefunds       AdminRefundRequest[]        @relation("ApprovedBy")
  notifications         AdminNotification[]
  documentActions       VerificationDocumentAction[]
}

// Admin Sessions - JWT-based sessions for web portal
model AdminSession {
  id                String   @id @default(uuid())
  adminUserId       String
  refreshTokenHash  String   @unique // Hashed refresh token for security
  userAgent         String? // Browser/device info
  ipAddress         String? // IP for security monitoring
  fcmToken          String? // For web push notifications
  lastNotifiedAt    DateTime? // Track last notification sent
  expiresAt         DateTime // Refresh token expiry (7-30 days)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastUsedAt        DateTime @default(now()) // Track last refresh

  adminUser         AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([expiresAt])
  @@index([refreshTokenHash])
  @@index([fcmToken])
}

// Audit Logs (Super Admin + Admin - immutable action log)
model AuditLog {
  id              String    @id @default(cuid())
  userId          String
  user            AdminUser @relation(fields: [userId], references: [id])
  role            AdminRole
  actionType      String    // APPROVED, REJECTED, CREATED, REVERTED, VIEWED, LOGIN, LOGOUT
  module          String    // VERIFICATION, REFUND, SUPPORT, FIELD_VERIFICATION, AUTH, SYSTEM
  description     String
  ipAddress       String?
  userAgent       String?
  beforeSnapshot  Json?
  afterSnapshot   Json?
  entityId        String?   // Related entity ID (driverId, bookingId, etc.)
  entityType      String?   // DRIVER, BOOKING, REFUND, etc.
  timestamp       DateTime  @default(now())

  @@index([userId, timestamp])
  @@index([module, timestamp])
  @@index([actionType, timestamp])
  @@index([timestamp])
}

// Driver Verification Requests (Wrapper around existing Driver verification)
// This tracks the verification workflow, LibreDesk ticket, and assignments
// The actual document statuses remain in DriverDocuments model
model DriverVerificationRequest {
  id                   String                      @id @default(cuid())
  driverId             String
  driver               Driver                      @relation(fields: [driverId], references: [id])
  verificationType     DriverVerificationType
  ticketId             String?                     @unique  // LibreDesk ticket ID
  assignedToId         String?
  assignedTo           AdminUser?                  @relation("AssignedTo", fields: [assignedToId], references: [id])
  status               VerificationRequestStatus
  reVerificationReason String?                     // Required for EXISTING_DRIVER type
  bufferExpiresAt      DateTime?
  revertReason         String?
  revertRequestedById  String?
  revertRequestedAt    DateTime?
  approvedAt           DateTime?
  approvedById         String?
  approvedBy           AdminUser?                  @relation("ApprovedBy", fields: [approvedById], references: [id])
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt

  fieldPhotos     FieldVerificationPhoto[]
  documentActions VerificationDocumentAction[]

  @@index([driverId])
  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
}

// Tracks individual document approval/rejection actions
// Links to existing DriverDocuments via documentField
model VerificationDocumentAction {
  id                    String                    @id @default(cuid())
  verificationRequestId String
  verificationRequest   DriverVerificationRequest @relation(fields: [verificationRequestId], references: [id])
  documentField         String                    // license, rcBook, fc, insurance, aadhar, selfie
  action                DocumentActionType
  rejectionReason       String?                   // Required if REJECTED
  actionById            String
  actionBy              AdminUser                 @relation(fields: [actionById], references: [id])
  actionAt              DateTime                  @default(now())

  @@index([verificationRequestId])
  @@index([actionById])
}

// Field Verification Photos (uploaded by Field Agent)
model FieldVerificationPhoto {
  id                    String                    @id @default(cuid())
  verificationRequestId String
  verificationRequest   DriverVerificationRequest @relation(fields: [verificationRequestId], references: [id])
  photoType             FieldPhotoType
  url                   String
  uploadedById          String
  uploadedAt            DateTime                  @default(now())

  @@index([verificationRequestId])
  @@map("field_verification_photos")
}

// Admin Refund Requests (supplement to existing RefundIntent)
// This adds admin workflow, buffer, revert functionality
model AdminRefundRequest {
  id                  String            @id @default(cuid())
  bookingId           String            @unique
  booking             Booking           @relation(fields: [bookingId], references: [id])
  customerId          String
  customer            Customer          @relation(fields: [customerId], references: [id])
  driverId            String?
  driver              Driver?           @relation(fields: [driverId], references: [id])
  amount              Decimal           @db.Decimal(10, 2)
  reason              String
  phoneNumber         String
  notes               String?
  evidenceUrls        String[]          // Array of evidence file URLs
  status              AdminRefundStatus
  createdById         String
  createdBy           AdminUser         @relation("CreatedBy", fields: [createdById], references: [id])
  approvedById        String?
  approvedBy          AdminUser?        @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedAt          DateTime?
  bufferExpiresAt     DateTime?
  revertReason        String?
  revertRequestedById String?
  revertRequestedAt   DateTime?
  completedAt         DateTime?
  refundIntentId      String?           // Link to actual RefundIntent after completion
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([customerId])
  @@index([driverId])
  @@index([status])
  @@index([createdAt])
}

// Support Notes for bookings
model SupportNote {
  id        String   @id @default(cuid())
  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id])
  agentId   String
  agentName String   // Denormalized for display
  note      String
  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([createdAt])
}

// Admin Notifications
model AdminNotification {
  id         String    @id @default(cuid())
  userId     String
  user       AdminUser @relation(fields: [userId], references: [id])
  title      String
  message    String
  entityId   String?   // Related entity ID
  entityType String?   // VERIFICATION, REFUND, etc.
  actionUrl  String?   // Link to relevant page
  isRead     Boolean   @default(false)
  createdAt  DateTime  @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

// ============================================
// ADMIN PORTAL ENUMS
// ============================================

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  AGENT
  FIELD_AGENT
  CUSTOMER_SUPPORT
}

// NOTE: Using different enum name to avoid collision with existing VerificationType
enum DriverVerificationType {
  NEW_DRIVER
  EXISTING_DRIVER
}

// NOTE: Different enum name to avoid collision with existing VerificationStatus
enum VerificationRequestStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  REVERT_REQUESTED
  REVERTED
  FINAL_APPROVED // After buffer expires
}

enum DocumentActionType {
  APPROVED
  REJECTED
}

enum FieldPhotoType {
  VEHICLE_FRONT
  VEHICLE_BACK
  VEHICLE_LEFT
  VEHICLE_RIGHT
  DRIVER_WITH_VEHICLE
  CHASSIS_NUMBER
}

// NOTE: Different enum name to avoid collision with existing RefundStatus
enum AdminRefundStatus {
  INITIATED
  APPROVED
  REJECTED
  REVERT_REQUESTED
  REVERTED
  COMPLETED
}
