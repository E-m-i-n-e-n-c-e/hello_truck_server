// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id          String   @id @default(uuid())
  phoneNumber String   @unique
  firstName   String?
  lastName    String?
  email       String?
  isBusiness  Boolean  @default(false)
  referralCode String?
  isActive    Boolean  @default(true)
  walletBalance Decimal @default(0) @db.Decimal(10,2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    CustomerSession[]
  gstDetails  CustomerGstDetails[]
  addresses   SavedAddress[]
  bookings    Booking[]
  transactions Transaction[]
  walletLogs   CustomerWalletLog[]
  refundIntents RefundIntent[]

  @@index([isActive])
}

model Address {
  id               String         @id @default(uuid())
  formattedAddress String
  addressDetails   String?
  latitude         Decimal        @db.Decimal(10, 8)
  longitude        Decimal        @db.Decimal(11, 8)

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  savedAddresses   SavedAddress?

  @@index([latitude, longitude])
}

model SavedAddress {
  id             String    @id @default(uuid())
  name           String
  contactName    String
  contactPhone   String
  noteToDriver   String?
  customerId     String
  customer       Customer  @relation(fields: [customerId], references: [id])
  addressId      String    @unique
  address        Address   @relation(fields: [addressId], references: [id])
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([customerId])
  @@unique([name, customerId], name: "unique_name_per_customer")
}

model CustomerGstDetails {
  id              String      @id @default(uuid())
  customerId      String
  customer        Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  gstNumber       String      @unique
  businessName    String
  businessAddress String
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([customerId, isActive])
  @@index([createdAt])
}

model CustomerSession {
  id          String   @id @default(uuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  token       String   @unique
  oldToken    String?  @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // FCM & device metadata
  fcmToken        String?
  lastNotifiedAt  DateTime?

  @@index([expiresAt])
  @@index([customerId])
  @@index([fcmToken])
}

model Driver {
  id                 String             @id @default(uuid())
  phoneNumber        String             @unique
  firstName          String?
  lastName           String?
  email              String?
  alternatePhone     String?
  referalCode        String?
  photo              String?
  contactId          String?
  fundAccountId      String?
  payoutMethod       PayoutMethodType?
  score              Int                @default(100)
  isActive           Boolean            @default(true)
  verificationStatus VerificationStatus @default(PENDING)
  driverStatus       DriverStatus       @default(UNAVAILABLE)
  walletBalance      Decimal            @default(0) @db.Decimal(10,2)
  createdAt          DateTime           @default(now())
  lastSeenAt         DateTime?
  updatedAt          DateTime           @updatedAt

  // Relations
  sessions           DriverSession[]
  address            DriverAddress?
  documents          DriverDocuments?
  vehicle            Vehicle?
  bookings           Booking[]
  assignments        BookingAssignment[]
  statusLogs         DriverStatusLog[]
  transactions       Transaction[]
  payouts            Payout[]
  walletLogs         DriverWalletLog[]

  @@index([isActive, verificationStatus])
  @@index([lastSeenAt, driverStatus])
}

model DriverDocuments {
  id              String    @id @default(uuid())
  driverId        String    @unique
  driver          Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  licenseUrl      String
  licenseExpiry   DateTime?
  licenseStatus   VerificationStatus @default(PENDING)
  rcBookUrl       String
  fcUrl           String
  fcExpiry        DateTime?
  fcStatus        VerificationStatus @default(PENDING)
  insuranceUrl    String
  insuranceExpiry DateTime?
  insuranceStatus VerificationStatus @default(PENDING)
  aadharUrl       String
  panNumber       String
  ebBillUrl       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([licenseExpiry])
  @@index([fcExpiry])
  @@index([insuranceExpiry])
}

model DriverSession {
  id          String   @id @default(uuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  token       String   @unique
  oldToken    String?  @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // FCM & device metadata
  fcmToken        String?
  lastNotifiedAt  DateTime?

  @@index([expiresAt])
  @@index([driverId])
  @@index([fcmToken])
}

model Vehicle {
  id                String          @id @default(uuid())
  driverId          String          @unique
  driver            Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicleNumber     String
  vehicleType       VehicleType

  // Add specific model reference
  vehicleModelName  String
  vehicleModel      VehicleModel    @relation(fields: [vehicleModelName], references: [name])

  vehicleBodyLength Decimal         @db.Decimal(3,1)
  vehicleBodyType   VehicleBodyType
  fuelType          FuelType
  vehicleImageUrl   String
  owner             VehicleOwner?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([vehicleNumber])
  @@index([vehicleModelName])
  @@index([vehicleType])
}

model VehicleModel {
  name           String        @id
  perKm          Decimal       @db.Decimal(10, 2)
  baseKm         Int
  baseFare       Decimal       @db.Decimal(10, 2)
  maxWeightTons  Decimal       @db.Decimal(10, 2)
  vehicles       Vehicle[]
}

model VehicleOwner {
  id            String   @id @default(uuid())
  vehicleId     String   @unique
  vehicle       Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  name          String
  aadharUrl     String
  contactNumber String
  addressLine1  String
  landmark      String?
  pincode       String
  city          String
  district      String
  state         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model DriverAddress {
  id            String   @id @default(uuid())
  driverId      String   @unique
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  addressLine1  String
  landmark      String?
  pincode       String
  city          String
  district      String
  state         String
  latitude      Decimal?   @db.Decimal(10, 8)
  longitude     Decimal?   @db.Decimal(11, 8)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([driverId])
}

model DriverStatusLog {
  id                String   @id @default(uuid())
  driverId          String
  driver            Driver   @relation(fields: [driverId], references: [id])
  status            DriverStatus
  statusChangedAt   DateTime @default(now())

  @@index([driverId, status])
  @@index([statusChangedAt])
}

model Package {
  id                    String             @id @default(uuid())

  // Product Type (PERSONAL, AGRICULTURAL, NON_AGRICULTURAL)
  productType          ProductType
  approximateWeight    Decimal             @db.Decimal(10,2)
  weightUnit           WeightUnit          @default(KG)

  // Personal/Agricultural Product Fields
  productName          String?

  // Non-Agricultural Product Fields
  bundleWeight         Decimal?            @db.Decimal(10,2)
  numberOfProducts     Int?
  length               Decimal?            @db.Decimal(10,2)
  width                Decimal?            @db.Decimal(10,2)
  height               Decimal?            @db.Decimal(10,2)
  dimensionUnit        DimensionUnit?      @default(CM)
  description          String?
  packageImageUrl      String?

  // Commercial Use Documents (for AGRICULTURAL and NON_AGRICULTURAL)
  gstBillUrl           String?
  transportDocUrls     String[]

  // Relations
  booking              Booking?

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
}

model BookingAddress {
  id String @id @default(uuid())

  addressName String?
  noteToDriver String?

  // Contact fields for bookings
  contactName String
  contactPhone String

  // Address
  formattedAddress String
  addressDetails String?
  latitude Decimal @db.Decimal(10, 8)
  longitude Decimal @db.Decimal(11, 8)

  // Relations
  pickupBooking Booking? @relation("PickupAddress")
  dropBooking   Booking? @relation("DropAddress")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([latitude, longitude])
}

model Booking {
  id                    String              @id @default(uuid())
  bookingNumber         BigInt              @unique @default(autoincrement())
  customerId           String?
  customer             Customer?            @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Package Details
  packageId            String              @unique
  package              Package             @relation(fields: [packageId], references: [id])

  // Address References (with contact info embedded)
  pickupAddressId      String              @unique
  pickupAddress        BookingAddress      @relation("PickupAddress", fields: [pickupAddressId], references: [id])
  dropAddressId        String              @unique
  dropAddress          BookingAddress      @relation("DropAddress", fields: [dropAddressId], references: [id])

  // OTPs
  pickupOtp            String
  dropOtp              String

  // Invoices (Pricing & Payment)
  invoices             Invoice[]

  // time stats
  acceptedAt           DateTime?
  pickupArrivedAt      DateTime?
  pickupVerifiedAt     DateTime?
  dropArrivedAt        DateTime?
  dropVerifiedAt       DateTime?
  completedAt          DateTime?
  cancelledAt          DateTime?
  cancellationReason   String?

  // Booking Status & Assignment
  status               BookingStatus       @default(PENDING)
  assignments          BookingAssignment[]
  assignedDriver       Driver?             @relation(fields: [assignedDriverId], references: [id], onDelete: SetNull)
  assignedDriverId     String?

  // Status logs
  statusLogs           BookingStatusLog[]

  // Transactions
  transactions         Transaction[]

  // Wallet logs
  driverWalletLogs     DriverWalletLog[]
  customerWalletLogs   CustomerWalletLog[]

  // Refund intents
  refundIntents        RefundIntent[]

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  scheduledAt          DateTime?

  @@index([customerId, status])
  @@index([assignedDriverId, status])
  @@index([status, createdAt])
}

model BookingAssignment {
  id          String            @id @default(uuid())
  bookingId   String
  booking     Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  driverId    String
  driver      Driver            @relation(fields: [driverId], references: [id], onDelete: Cascade)
  status      AssignmentStatus  @default(OFFERED)
  offeredAt   DateTime          @default(now())
  respondedAt DateTime?

  @@unique([bookingId, driverId])
  @@index([bookingId, status])
  @@index([driverId, status])
  @@index([status, offeredAt])
}

model BookingStatusLog {
  id          String              @id @default(uuid())
  bookingId   String
  booking     Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  status      BookingStatus
  statusChangedAt   DateTime            @default(now())

  @@index([bookingId, status])
  @@index([statusChangedAt])
}

model Invoice {
  id                 String        @id @default(uuid())
  bookingId          String
  booking            Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  type               InvoiceType

  // Snapshot of pricing details at time of generation
  vehicleModelName   String
  basePrice          Decimal       @db.Decimal(10, 2)
  perKmPrice         Decimal       @db.Decimal(10, 2)
  baseKm             Int

  distanceKm         Decimal       @db.Decimal(10, 2)
  weightInTons       Decimal       @db.Decimal(10, 2)

  // Calculation Results
  effectiveBasePrice Decimal       @db.Decimal(10, 2)
  totalPrice         Decimal       @db.Decimal(10, 2)

  // Payment Details (Only relevant for FINAL invoice)
  walletApplied      Decimal       @default(0) @db.Decimal(10, 2)
  finalAmount        Decimal       @db.Decimal(10, 2)
  paymentLinkUrl     String?
  rzpPaymentLinkId   String?       @unique
  rzpPaymentId       String?

  // Payment status
  isPaid             Boolean       @default(false)
  paidAt             DateTime?
  paymentMethod      PaymentMethod?

  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@unique([bookingId, type]) // One estimate and one final per booking
  @@index([bookingId])
}

// Central transaction ledger for ALL financial transactions on the platform
// Transactions are immutable audit records and should NEVER be deleted
model Transaction {
  id String @id @default(uuid())

  // Parties involved (at least one must be set)
  // No cascade delete - transactions are preserved for audit even if users are deleted
  customerId String?
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  driverId String?
  driver Driver? @relation(fields: [driverId], references: [id], onDelete: SetNull)

  // Transaction details
  amount Decimal @db.Decimal(10,2)
  type TransactionType // CREDIT or DEBIT
  category TransactionCategory // What kind of transaction
  description String

  // References to related entities
  bookingId String?
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  payoutId String?
  payout Payout? @relation(fields: [payoutId], references: [id], onDelete: SetNull)
  refundIntentId String?
  refundIntent RefundIntent? @relation(fields: [refundIntentId], references: [id], onDelete: SetNull)

  // Metadata
  metadata Json? // For storing additional context

  // payment method
  paymentMethod PaymentMethod

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
  @@index([driverId, createdAt])
  @@index([bookingId])
  @@index([payoutId])
  @@index([category, createdAt])
}

model Payout {
  id String @id @default(uuid())
  driverId String
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  amount Decimal @db.Decimal(10,2)
  razorpayPayoutId String? @unique
  status PayoutStatus @default(PENDING)
  failureReason String?
  retryCount Int @default(0)

  transactions Transaction[] // Link to transaction records

  createdAt DateTime @default(now())
  processedAt DateTime?

  @@index([driverId, status])
  @@index([status, createdAt])
}

model DriverWalletLog {
  id            String   @id @default(uuid())
  driverId      String
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  // Wallet change details
  beforeBalance Decimal  @db.Decimal(10, 2)
  afterBalance  Decimal  @db.Decimal(10, 2)
  amount        Decimal  @db.Decimal(10, 2)  // Change amount (+ or -)
  reason        String   // e.g., "Booking earnings", "Commission deduction"

  // Optional reference
  bookingId     String?
  booking       Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  createdAt     DateTime @default(now())

  @@index([driverId, createdAt])
  @@index([createdAt])
}

model CustomerWalletLog {
  id            String    @id @default(uuid())
  customerId    String
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Wallet change details
  beforeBalance Decimal   @db.Decimal(10, 2)
  afterBalance  Decimal   @db.Decimal(10, 2)
  amount        Decimal   @db.Decimal(10, 2)  // Change amount (+ or -)
  reason        String    // e.g., "Applied to booking", "Refund"

  // Optional reference
  bookingId     String?
  booking       Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  refundIntentId String?
  refundIntent  RefundIntent? @relation(fields: [refundIntentId], references: [id], onDelete: SetNull)

  createdAt     DateTime  @default(now())

  @@index([customerId, createdAt])
  @@index([createdAt])
}

model RefundIntent {
  id                   String        @id @default(uuid())
  bookingId            String        @unique
  booking              Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customerId           String
  customer             Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Refund breakdown
  walletRefundAmount   Decimal       @db.Decimal(10,2)
  razorpayRefundAmount Decimal       @db.Decimal(10,2)
  cancellationCharge   Decimal       @db.Decimal(10,2)
  wasPaid              Boolean       // Track if invoice was paid at cancellation time

  // Razorpay metadata
  rzpPaymentId         String?
  rzpRefundId          String?

  // Status tracking
  status               RefundStatus  @default(PENDING)
  failureReason        String?
  retryCount           Int           @default(0)
  maxRetries           Int           @default(3)

  // Transactions
  transactions         Transaction[]
  customerWalletLogs  CustomerWalletLog[]

  // Timestamps
  createdAt            DateTime      @default(now())
  processedAt          DateTime?

  @@index([status])
  @@index([bookingId])
}

model WebhookLog {
  id               String   @id @default(uuid())
  event            String   // e.g., "payment_link.paid"
  payload          Json
  signature        String
  createdAt        DateTime @default(now())
}

// Enums
enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VehicleType {
  THREE_WHEELER
  FOUR_WHEELER
}

enum VehicleBodyType {
  OPEN
  CLOSED
}

enum FuelType {
  DIESEL
  PETROL
  EV
  CNG
}

enum ProductType {
  PERSONAL
  AGRICULTURAL
  NON_AGRICULTURAL
}

enum WeightUnit {
  KG
  QUINTAL
}

enum DimensionUnit {
  CM
  INCHES
}

enum BookingStatus {
  PENDING
  DRIVER_ASSIGNED
  CONFIRMED
  PICKUP_ARRIVED
  PICKUP_VERIFIED
  IN_TRANSIT
  DROP_ARRIVED
  DROP_VERIFIED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum AssignmentStatus {
  OFFERED
  ACCEPTED
  REJECTED
  AUTO_REJECTED
}

enum DriverStatus {
  AVAILABLE
  UNAVAILABLE
  ON_RIDE
  RIDE_OFFERED
}

enum LifecycleEventType {
  PICKUP_ARRIVED
  PICKUP_VERIFIED
  IN_TRANSIT
  DROP_ARRIVED
  DROP_VERIFIED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ReferralStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionCategory {
  BOOKING_PAYMENT  // Customer pays for booking
  BOOKING_REFUND   // Refund to customer (Razorpay)
  DRIVER_PAYOUT    // Payout to driver (Razorpay)
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum InvoiceType {
  ESTIMATE
  FINAL
}

enum PaymentMethod {
  ONLINE
  CASH
}

enum PayoutMethodType {
  BANK_ACCOUNT
  VPA
}

enum RefundStatus {
  PENDING           // Created, waiting for processing
  PROCESSING        // Razorpay call in progress
  COMPLETED         // Fully processed
  FAILED            // Failed after max retries
  NOT_REQUIRED      // No refund needed
}