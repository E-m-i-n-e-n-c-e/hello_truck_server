// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id          String   @id @default(uuid())
  phoneNumber String   @unique
  firstName   String?
  lastName    String?
  email       String?
  isBusiness  Boolean  @default(false)
  referralCode String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    CustomerSession[]
  gstDetails  CustomerGstDetails[]
  addresses   SavedAddress[]
  bookings    Booking[]

  @@index([isActive])
}

model Address {
  id               String         @id @default(uuid())
  formattedAddress String
  addressDetails   String?
  latitude         Decimal        @db.Decimal(10, 8)
  longitude        Decimal        @db.Decimal(11, 8)

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  savedAddresses   SavedAddress?

  @@index([latitude, longitude])
}

model SavedAddress {
  id             String    @id @default(uuid())
  name           String
  contactName    String
  contactPhone   String
  noteToDriver   String?
  customerId     String
  customer       Customer  @relation(fields: [customerId], references: [id])
  addressId      String    @unique
  address        Address   @relation(fields: [addressId], references: [id])
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([customerId])
  @@unique([name, customerId], name: "unique_name_per_customer")
}

model CustomerGstDetails {
  id              String      @id @default(uuid())
  customerId      String
  customer        Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  gstNumber       String      @unique
  businessName    String
  businessAddress String
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([customerId, isActive])
  @@index([createdAt])
}

model CustomerSession {
  id          String   @id @default(uuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  token       String   @unique
  oldToken    String?  @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // FCM & device metadata
  fcmToken        String?
  lastNotifiedAt  DateTime?

  @@index([expiresAt])
  @@index([customerId])
  @@index([fcmToken])
}

model Driver {
  id                 String             @id @default(uuid())
  phoneNumber        String             @unique
  firstName          String?
  lastName           String?
  email              String?
  alternatePhone     String?
  referalCode        String?
  photo              String?
  contactId          String?
  fundAccountId      String?
  score              Int                @default(0)
  latitude           Decimal?           @db.Decimal(10, 8)
  longitude          Decimal?           @db.Decimal(11, 8)
  isActive           Boolean            @default(true)
  verificationStatus VerificationStatus @default(PENDING)
  driverStatus       DriverStatus       @default(UNAVAILABLE)
  createdAt          DateTime           @default(now())
  lastSeenAt         DateTime?
  updatedAt          DateTime           @updatedAt

  // Relations
  sessions           DriverSession[]
  address            DriverAddress?
  documents          DriverDocuments?
  vehicle            Vehicle?
  bookings           Booking[]
  assignments        BookingAssignment[]
  statusLogs         DriverStatusLog[]

  @@index([isActive, verificationStatus])
  @@index([lastSeenAt, driverStatus])
}

model DriverDocuments {
  id              String    @id @default(uuid())
  driverId        String    @unique
  driver          Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  licenseUrl      String
  licenseExpiry   DateTime?
  licenseStatus   VerificationStatus @default(PENDING)
  rcBookUrl       String
  fcUrl           String
  fcExpiry        DateTime?
  fcStatus        VerificationStatus @default(PENDING)
  insuranceUrl    String
  insuranceExpiry DateTime?
  insuranceStatus VerificationStatus @default(PENDING)
  aadharUrl       String
  panNumber       String    @unique
  ebBillUrl       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([licenseExpiry])
  @@index([fcExpiry])
  @@index([insuranceExpiry])
}

model DriverSession {
  id          String   @id @default(uuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  token       String   @unique
  oldToken    String?  @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // FCM & device metadata
  fcmToken        String?
  lastNotifiedAt  DateTime?

  @@index([expiresAt])
  @@index([driverId])
  @@index([fcmToken])
}

model Vehicle {
  id                String          @id @default(uuid())
  driverId          String          @unique
  driver            Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicleNumber     String          @unique
  vehicleType       VehicleType
  vehicleBodyLength Decimal         @db.Decimal(3,1)
  vehicleBodyType   VehicleBodyType
  fuelType          FuelType
  vehicleImageUrl   String
  owner             VehicleOwner?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([vehicleNumber])
}

model VehicleOwner {
  id            String   @id @default(uuid())
  vehicleId     String   @unique
  vehicle       Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  name          String
  aadharUrl     String
  contactNumber String
  addressLine1  String
  landmark      String?
  pincode       String
  city          String
  district      String
  state         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model DriverAddress {
  id            String   @id @default(uuid())
  driverId      String   @unique
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  addressLine1  String
  landmark      String?
  pincode       String
  city          String
  district      String
  state         String
  latitude      Decimal?   @db.Decimal(10, 8)
  longitude     Decimal?   @db.Decimal(11, 8)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([driverId])
}

model DriverStatusLog {
  id                String   @id @default(uuid())
  driverId          String
  driver            Driver   @relation(fields: [driverId], references: [id])
  status            DriverStatus
  statusChangedAt   DateTime @default(now())

  @@index([driverId, status])
  @@index([statusChangedAt])
}

model Package {
  id                    String             @id @default(uuid())

  // Package Type
  packageType          PackageType         @default(PERSONAL)
  productType          ProductType

  // Agricultural Product Fields
  productName          String?
  approximateWeight    Decimal?            @db.Decimal(10,2)
  weightUnit           WeightUnit          @default(KG)

  // Non-Agricultural Product Fields
  averageWeight        Decimal?            @db.Decimal(10,2)
  bundleWeight         Decimal?            @db.Decimal(10,2)
  numberOfProducts     Int?
  length               Decimal?            @db.Decimal(10,2)
  width                Decimal?            @db.Decimal(10,2)
  height               Decimal?            @db.Decimal(10,2)
  dimensionUnit        DimensionUnit?      @default(CM)
  description          String?
  packageImageUrl      String?

  // Commercial Use Documents
  gstBillUrl           String?
  transportDocUrls     String[]

  // Relations
  booking              Booking?

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
}

model BookingAddress {
  id String @id @default(uuid())

  addressName String?
  noteToDriver String?

  // Contact fields for bookings
  contactName String
  contactPhone String

  // Address
  formattedAddress String
  addressDetails String?
  latitude Decimal @db.Decimal(10, 8)
  longitude Decimal @db.Decimal(11, 8)

  // Relations
  pickupBooking Booking? @relation("PickupAddress")
  dropBooking   Booking? @relation("DropAddress")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([latitude, longitude])
}

model Booking {
  id                    String              @id @default(uuid())
  bookingNumber         BigInt              @unique @default(autoincrement())
  customerId           String
  customer             Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Package Details
  packageId            String              @unique
  package              Package             @relation(fields: [packageId], references: [id])

  // Address References (with contact info embedded)
  pickupAddressId      String              @unique
  pickupAddress        BookingAddress      @relation("PickupAddress", fields: [pickupAddressId], references: [id])
  dropAddressId        String              @unique
  dropAddress          BookingAddress      @relation("DropAddress", fields: [dropAddressId], references: [id])

  // Pricing & Route
  estimatedCost        Decimal             @db.Decimal(10,2)
  finalCost            Decimal?            @db.Decimal(10,2)
  distanceKm           Decimal             @db.Decimal(10,2)
  baseFare             Decimal             @db.Decimal(10,2)
  distanceCharge       Decimal             @db.Decimal(10,2)
  weightMultiplier     Decimal             @db.Decimal(3,2) @default(1.0)
  vehicleMultiplier    Decimal             @db.Decimal(3,2) @default(1.0)
  suggestedVehicleType VehicleType

  // OTPs
  pickupOtp            String?
  dropOtp              String?

  // Payment
  paymentLinkUrl       String?
  rzpOrderId           String?
  rzpPaymentId         String?

  // time stats
  acceptedAt           DateTime?
  pickupArrivedAt      DateTime?
  pickupVerifiedAt     DateTime?
  dropArrivedAt        DateTime?
  dropVerifiedAt       DateTime?
  completedAt          DateTime?

  // Booking Status & Assignment
  status               BookingStatus       @default(PENDING)
  assignments          BookingAssignment[]
  assignedDriver       Driver?             @relation(fields: [assignedDriverId], references: [id], onDelete: SetNull)
  assignedDriverId     String?

  // Status logs
  statusLogs           BookingStatusLog[]

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  scheduledAt          DateTime?

  @@index([customerId, status])
  @@index([assignedDriverId, status])
  @@index([status, createdAt])
}

model BookingAssignment {
  id          String            @id @default(uuid())
  bookingId   String
  booking     Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  driverId    String
  driver      Driver            @relation(fields: [driverId], references: [id], onDelete: Cascade)
  status      AssignmentStatus  @default(OFFERED)
  offeredAt   DateTime          @default(now())
  respondedAt DateTime?

  @@unique([bookingId, driverId])
  @@index([bookingId, status])
  @@index([driverId, status])
  @@index([status, offeredAt])
}

model BookingStatusLog {
  id          String              @id @default(uuid())
  bookingId   String
  booking     Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  status      BookingStatus
  statusChangedAt   DateTime            @default(now())

  @@index([bookingId, status])
  @@index([statusChangedAt])
}


// Enums
enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VehicleType {
  TWO_WHEELER
  THREE_WHEELER
  FOUR_WHEELER
}

enum VehicleBodyType {
  OPEN
  CLOSED
}

enum FuelType {
  DIESEL
  PETROL
  EV
  CNG
}

enum PackageType {
  PERSONAL
  COMMERCIAL
}

enum ProductType {
  AGRICULTURAL
  NON_AGRICULTURAL
}

enum WeightUnit {
  KG
  QUINTAL
}

enum DimensionUnit {
  CM
  INCHES
}

enum BookingStatus {
  PENDING
  DRIVER_ASSIGNED
  CONFIRMED
  PICKUP_ARRIVED
  PICKUP_VERIFIED
  IN_TRANSIT
  DROP_ARRIVED
  DROP_VERIFIED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum AssignmentStatus {
  OFFERED
  ACCEPTED
  REJECTED
  AUTO_REJECTED
}

enum DriverStatus {
  AVAILABLE
  UNAVAILABLE
  ON_RIDE
  RIDE_OFFERED
}

enum LifecycleEventType {
  PICKUP_ARRIVED
  PICKUP_VERIFIED
  IN_TRANSIT
  DROP_ARRIVED
  DROP_VERIFIED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ReferralStatus {
  PENDING
  COMPLETED
  FAILED
}